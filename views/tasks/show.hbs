<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>{{task.title}}</h1>
  {{#if isAuthor}}
    <div class="d-flex gap-2">
      {{#if (eq task.status 'open')}}
        <a href="/tasks/{{task._id}}/edit" class="btn btn-warning">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
      {{/if}}
      {{#if (eq task.status 'in_progress')}}
        <form action="/tasks/{{task._id}}/close" method="POST" class="d-inline">
          <button type="submit" class="btn btn-success">–ó–∞–∫—Ä—ã—Ç—å –∑–∞–¥–∞—á—É</button>
        </form>
      {{/if}}
    </div>
  {{/if}}
</div>

<div class="row">
  <div class="col-md-8">
    <div class="card mb-4">
      <div class="card-body">
        <div class="d-flex align-items-center mb-3">
          <i class="{{task.category.icon}} me-2"></i>
          <span class="badge bg-secondary me-2">{{task.category.name}}</span>
          <span class="badge {{#if (eq task.status 'open')}}bg-success{{else if (eq task.status 'in_progress')}}bg-warning{{else}}bg-secondary{{/if}}">
            {{#if (eq task.status 'open')}}–û—Ç–∫—Ä—ã—Ç–∞{{else if (eq task.status 'in_progress')}}–í —Ä–∞–±–æ—Ç–µ{{else}}–ó–∞–∫—Ä—ã—Ç–∞{{/if}}
          </span>
        </div>
        <p class="card-text">{{task.description}}</p>
        <div class="d-flex justify-content-between align-items-center">
          <small class="text-muted">–ê–≤—Ç–æ—Ä:
            <a href="/users/{{task.author.username}}" target="_blank" class="text-decoration-none">
              {{#if task.author.firstName}}
                {{task.author.firstName}} {{task.author.lastName}}
              {{else}}
                {{task.author.username}}
              {{/if}}
            </a>
          </small>
          <small class="text-muted">{{task.createdAtFormatted}}</small>
        </div>
      </div>
    </div>

    <h3>–û—Ç–∫–ª–∏–∫–∏ {{#if responses.length}}({{responses.length}}){{/if}}</h3>

    {{#if user}}
      {{#if (eq task.status 'open')}}
        {{#unless isAuthor}}
          {{#unless hasResponded}}
            <div class="card mb-4">
            <div class="card-header">–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∫–ª–∏–∫</div>
            <div class="card-body">
              <form action="/tasks/{{task._id}}/response" method="POST">
                <div class="mb-3">
                  <label for="message" class="form-label">–í–∞—à–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</label>
                  <textarea class="form-control" id="message" name="message" rows="3" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∫–ª–∏–∫</button>
              </form>
            </div>
          </div>
          {{/unless}}
        {{/unless}}
      {{/if}}
    {{else}}
      <div class="alert alert-info mb-4">
        <i class="fas fa-info-circle me-2"></i>
        <strong>–•–æ—Ç–∏—Ç–µ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –∑–∞–¥–∞—á—É?</strong>
        <a href="/login" class="alert-link">–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç</a> –∏–ª–∏
        <a href="/register" class="alert-link">–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</a>, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∫–ª–∏–∫.
      </div>
    {{/if}}

    {{#each responses}}
      {{#if (or ../isAuthor isOwnResponse)}}
      <div class="card mb-3 {{#if (eq status 'accepted')}}border-success{{else if (eq status 'rejected')}}border-danger{{/if}}">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <strong>
              {{#if responder.name}}
                <a href="/users/{{responder.username}}" target="_blank" class="text-decoration-none">
                  {{responder.name}}{{#if (eq responder._id ../currentUserId)}} (–í—ã){{/if}}
                </a>
              {{else}}
                <a href="/users/{{responder.username}}" target="_blank" class="text-decoration-none">
                  {{responder.username}}{{#if (eq responder._id ../currentUserId)}} (–í—ã){{/if}}
                </a>
              {{/if}}
            </strong>
            <div>
              {{#if (eq status 'accepted')}}
                <span class="badge bg-success">–ü—Ä–∏–Ω—è—Ç</span>
              {{else if (eq status 'rejected')}}
                <span class="badge bg-danger">–û—Ç–∫–ª–æ–Ω–µ–Ω</span>
              {{else}}
                <span class="badge bg-secondary">–û–∂–∏–¥–∞–µ—Ç</span>
              {{/if}}
            </div>
          </div>
          <div id="response-display-{{_id}}">
            <p class="mb-2">{{message}}</p>
            <small class="text-muted">{{createdAtFormatted}}</small>
          </div>

          <div id="response-edit-{{_id}}" style="display: none;">
            <form action="/tasks/{{../task._id}}/response/{{_id}}/edit" method="POST" class="mt-2">
              <div class="mb-3">
                <textarea class="form-control" name="message" rows="3" required>{{message}}</textarea>
              </div>
              <button type="submit" class="btn btn-success btn-sm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button type="button" class="btn btn-secondary btn-sm ms-2" onclick="cancelEdit('{{_id}}')">–û—Ç–º–µ–Ω–∞</button>
            </form>
          </div>

          {{#if ../isAuthor}}
            {{#if (eq status 'pending')}}
              <div class="mt-2">
                <form action="/tasks/{{../task._id}}/response/{{_id}}/accept" method="POST" class="d-inline">
                  <button type="submit" class="btn btn-success btn-sm">–ü—Ä–∏–Ω—è—Ç—å</button>
                </form>
                <button type="button" class="btn btn-danger btn-sm ms-2" onclick="rejectResponse('{{_id}}')">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
              </div>
            {{/if}}
          {{else if isOwnResponse}}
            {{#if (eq status 'pending')}}
              <div class="mt-2" id="response-actions-{{_id}}">
                <button type="button" class="btn btn-primary btn-sm" onclick="editResponse('{{_id}}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <button type="button" class="btn btn-danger btn-sm ms-2" onclick="deleteResponse('{{_id}}')">–£–¥–∞–ª–∏—Ç—å</button>
              </div>
            {{/if}}
          {{/if}}
        </div>
      </div>
      {{/if}}
    {{else}}
      <div class="text-center text-muted mt-4">
        <p>–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∫–ª–∏–∫–æ–≤</p>
      </div>
    {{/each}}

    <!-- –ü–µ—Ä–µ–ø–∏—Å–∫–∞ –º–µ–∂–¥—É —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ –∑–∞–¥–∞—á–∏ -->
    {{#if (and user (or (eq task.status 'in_progress') (eq task.status 'closed')))}}
      {{#if (or isAuthor hasResponded)}}
        <div class="card mt-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">–ü–µ—Ä–µ–ø–∏—Å–∫–∞
              {{#if (eq task.status 'closed')}}
                <span class="badge bg-secondary ms-2">–ó–∞–¥–∞—á–∞ –∑–∞–∫—Ä—ã—Ç–∞</span>
              {{/if}}
            </h5>
            <div class="d-flex align-items-center gap-2">
              <button type="button" class="btn btn-sm btn-outline-primary" onclick="loadMessages()">
                <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
              </button>
              <small class="text-muted">
                {{#if isAuthor}}
                  –û–±—â–µ–Ω–∏–µ —Å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–º
                {{else}}
                  –û–±—â–µ–Ω–∏–µ —Å –∑–∞–∫–∞–∑—á–∏–∫–æ–º
                {{/if}}
                {{#if (eq task.status 'closed')}}
                  <span class="ms-1 text-warning">(–∑–∞–¥–∞—á–∞ –∑–∞–∫—Ä—ã—Ç–∞)</span>
                {{/if}}
              </small>
            </div>
          </div>
          <div class="card-body">
            {{#if (eq task.status 'closed')}}
              <div class="alert alert-warning text-center mb-3">
                <i class="fas fa-info-circle me-2"></i>
                <strong>–ó–∞–¥–∞—á–∞ –∑–∞–∫—Ä—ã—Ç–∞</strong> - –ø–µ—Ä–µ–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ä–∞–±–æ—Ç—ã
              </div>
            {{/if}}
            <div id="messages-container" style="height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 15px; margin-bottom: 15px;">
              <div class="text-center text-muted">
                <div class="spinner-border spinner-border-sm" role="status">
                  <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</span>
                </div>
                <div>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>
              </div>
            </div>

            <form id="message-form">
              <div class="input-group">
                <textarea class="form-control" id="message-input" name="message" rows="2" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." maxlength="1000" required></textarea>
                <button class="btn btn-primary" type="submit" id="send-button">
                  <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                </button>
              </div>
              <div class="form-text">–ú–∞–∫—Å–∏–º—É–º 1000 —Å–∏–º–≤–æ–ª–æ–≤</div>
            </form>
          </div>
        </div>
      {{/if}}
    {{/if}}
  </div>

  <div class="col-md-4">
    <div class="card">
      <div class="card-header">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–¥–∞—á–µ</div>
      <div class="card-body">
        <p><strong>–°—Ç–∞—Ç—É—Å:</strong>
          {{#if (eq task.status 'open')}}–û—Ç–∫—Ä—ã—Ç–∞{{else if (eq task.status 'in_progress')}}–í —Ä–∞–±–æ—Ç–µ{{else}}–ó–∞–∫—Ä—ã—Ç–∞{{/if}}
        </p>
        {{#if task.acceptedResponse}}
          <p><strong>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:</strong>
            <a href="/users/{{task.acceptedResponse.responder.username}}" target="_blank" class="text-decoration-none">
              {{#if task.acceptedResponse.responder.firstName}}
                {{task.acceptedResponse.responder.firstName}} {{task.acceptedResponse.responder.lastName}}
              {{else}}
                {{task.acceptedResponse.responder.username}}
              {{/if}}
            </a>
          </p>
        {{/if}}
        <p><strong>–°–æ–∑–¥–∞–Ω–æ:</strong> {{task.createdAtFormatted}}</p>
      </div>
    </div>
  </div>
</div>

<a href="/tasks" class="btn btn-secondary mt-3">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É</a>

<script>
function rejectResponse(responseId) {
  if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–ª–æ–Ω–∏—Ç—å —ç—Ç–æ—Ç –æ—Ç–∫–ª–∏–∫?')) {
    // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã, –ø–æ–∫–∞ —á—Ç–æ –æ—Å—Ç–∞–≤–∏–º –±–µ–∑ –¥–µ–π—Å—Ç–≤–∏—è, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å AJAX –ø–æ–∑–∂–µ
    alert('–§—É–Ω–∫—Ü–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞');
  }
}

function editResponse(responseId) {
  // –°–∫—Ä—ã—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç–∫–ª–∏–∫–∞
  document.getElementById('response-display-' + responseId).style.display = 'none';
  // –°–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
  document.getElementById('response-actions-' + responseId).style.display = 'none';
  // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  document.getElementById('response-edit-' + responseId).style.display = 'block';
}

function cancelEdit(responseId) {
  // –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç–∫–ª–∏–∫–∞
  document.getElementById('response-display-' + responseId).style.display = 'block';
  // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
  document.getElementById('response-actions-' + responseId).style.display = 'block';
  // –°–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  document.getElementById('response-edit-' + responseId).style.display = 'none';
}

function deleteResponse(responseId) {
  if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–≤–æ–π –æ—Ç–∫–ª–∏–∫?')) {
    // –°–æ–∑–¥–∞–µ–º —Ñ–æ—Ä–º—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/tasks/' + '{{task._id}}' + '/response/' + responseId + '/delete';

    // –î–æ–±–∞–≤–ª—è–µ–º CSRF —Ç–æ–∫–µ–Ω, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = '_csrf';
    csrfInput.value = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
    form.appendChild(csrfInput);

    document.body.appendChild(form);
    form.submit();
  }
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
const taskId = '{{task._id}}';

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
async function loadMessages() {
  try {
    const response = await fetch(`/tasks/${taskId}/messages`);
    const data = await response.json();

    if (data.success) {
      displayMessages(data.messages);
    } else {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', data.error);
      document.getElementById('messages-container').innerHTML =
        '<div class="alert alert-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π: ' + data.error + '</div>';
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error);
    document.getElementById('messages-container').innerHTML =
      '<div class="alert alert-danger">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
  }
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
function displayMessages(messages) {
  const container = document.getElementById('messages-container');

  if (messages.length === 0) {
    container.innerHTML = '<div class="text-center text-muted">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
    return;
  }

  let html = '';
  messages.forEach(message => {
    const isSystemMessage = message.isSystemMessage || false;
    if (isSystemMessage) {
      // –°–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –ø–æ —Ü–µ–Ω—Ç—Ä—É
      html += `
        <div class="alert alert-info text-center" style="max-width: 80%; margin: 10px auto; background-color: #e3f2fd;">
          <div class="d-flex justify-content-center align-items-center mb-1">
            <small class="text-muted">${new Date(message.createdAt).toLocaleString('ru-RU')}</small>
          </div>
          <div><strong>üîî –°–∏—Å—Ç–µ–º–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:</strong> ${message.message.replace(/\n/g, '<br>')}</div>
        </div>
      `;
    } else {
      const isOwn = message.sender && message.sender._id === '{{currentUserId}}';
      const messageClass = isOwn ? 'alert alert-primary ms-auto' : 'alert alert-secondary me-auto';
      const messageStyle = isOwn ? 'margin-left: auto; margin-right: 0;' : 'margin-left: 0; margin-right: auto;';

      html += `
        <div class="${messageClass}" style="max-width: 70%; ${messageStyle}">
          <div class="d-flex justify-content-between align-items-start mb-1">
            <strong>${isOwn ? '–í—ã' : (message.sender.firstName || message.sender.username)}</strong>
            <small class="text-muted">${new Date(message.createdAt).toLocaleString('ru-RU')}</small>
          </div>
          <div>${message.message.replace(/\n/g, '<br>')}</div>
        </div>
      `;
    }
  });

  container.innerHTML = html;
  container.scrollTop = container.scrollHeight;
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
async function sendMessage(message) {
  try {
    const response = await fetch(`/tasks/${taskId}/messages`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ message })
    });

    const data = await response.json();

    if (data.success) {
      document.getElementById('message-input').value = '';
      loadMessages(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
    } else {
      alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + data.error);
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error);
    alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è');
  }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
  const messageForm = document.getElementById('message-form');
  const messageInput = document.getElementById('message-input');

  if (messageForm) {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è —Å—Ä–∞–∑—É –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadMessages();

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    messageForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const message = messageInput.value.trim();

      if (message) {
        sendMessage(message);
      }
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ Ctrl+Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    messageInput.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        const message = this.value.trim();
        if (message) {
          sendMessage(message);
        }
      }
    });
  }
});

</script>