<div class="container mt-4 mb-4">
    <div class="row">
        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç –≤ –±–µ–ª–æ–º –±–ª–æ–∫–µ -->
        <div class="col-lg-8">
            <div class="card task-card">
                <div class="card-body p-4">
                    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –¥–µ–π—Å—Ç–≤–∏—è -->
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 pb-4 border-bottom gap-3">
                        <div class="flex-grow-1">
                            <h1 class="mb-2" style="color: #1565c0; font-size: 2rem;">{{task.title}}</h1>
                            <div class="d-flex align-items-center gap-2 flex-wrap">
                                <span class="task-category">
                                    <i class="{{task.category.icon}} me-1"></i>{{task.category.name}}
                                </span>
                                <span class="badge {{#if (eq task.status 'open')}}bg-success{{else if (eq task.status 'in_progress')}}bg-warning{{else}}bg-secondary{{/if}}">
                                    {{#if (eq task.status 'open')}}–û—Ç–∫—Ä—ã—Ç–∞{{else if (eq task.status 'in_progress')}}–í —Ä–∞–±–æ—Ç–µ{{else}}–ó–∞–∫—Ä—ã—Ç–∞{{/if}}
                                </span>
                            </div>
                        </div>
                        {{#if isAuthor}}
                            <div class="d-flex gap-2">
                                {{#if (eq task.status 'open')}}
                                    <a href="/tasks/{{task._id}}/edit" class="btn btn-outline-warning">
                                        <i class="bi bi-pencil me-1"></i>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                    </a>
                                {{/if}}
                                {{#if (eq task.status 'in_progress')}}
                                    <form action="/tasks/{{task._id}}/close" method="POST" class="d-inline">
                                        <button type="submit" class="btn btn-success">
                                            <i class="bi bi-check-circle me-1"></i>–ó–∞–∫—Ä—ã—Ç—å –∑–∞–¥–∞—á—É
                                        </button>
                                    </form>
                                {{/if}}
                            </div>
                        {{/if}}
                    </div>

                    <!-- –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ -->
                    <div class="mb-4 pb-4 border-bottom">
                        <div class="task-description-full">
                            {{task.description}}
                        </div>
                    </div>

                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–¥–∞—á–µ -->
                    <div class="mb-4">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-person-circle me-2" style="font-size: 1.5rem; color: var(--youdo-blue);"></i>
                                <div>
                                    <small class="text-muted d-block">–ó–∞–∫–∞–∑—á–∏–∫</small>
                                    <a href="/users/{{task.author.username}}" target="_blank" class="text-decoration-none fw-bold">
                                        {{#if task.author.firstName}}
                                            {{task.author.firstName}} {{task.author.lastName}}
                                        {{else}}
                                            {{task.author.username}}
                                        {{/if}}
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-calendar me-2" style="font-size: 1.5rem; color: var(--youdo-blue);"></i>
                                <div>
                                    <small class="text-muted d-block">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</small>
                                    <span class="fw-bold">{{task.createdAtFormatted}}</span>
                                </div>
                            </div>
                        </div>
                    </div>
            </div>
                </div>
            </div>

                    <!-- –û—Ç–∫–ª–∏–∫–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –±–µ–ª–æ–º –±–ª–æ–∫–µ -->
                    <div class="mt-4">
                        <div class="card task-card">
                            <div class="card-body p-4">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h3 class="mb-0">
                                        <i class="bi bi-chat-dots me-2"></i>–û—Ç–∫–ª–∏–∫–∏
                                        {{#if responses.length}}
                                            <span class="badge bg-primary">{{responses.length}}</span>
                                        {{/if}}
                                    </h3>
                                </div>

                                {{#if user}}
                                    {{#if (eq task.status 'open')}}
                                        {{#unless isAuthor}}
                                            {{#unless hasResponded}}
                                                <div class="mb-4 p-3 border border-primary rounded">
                                                    <h5 class="mb-3 text-primary">
                                                        <i class="bi bi-pencil-square me-2"></i>–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∫–ª–∏–∫
                                                    </h5>
                                                    <form action="/tasks/{{task._id}}/response" method="POST">
                                                        <div class="mb-3">
                                                            <label for="message" class="form-label fw-bold">–í–∞—à–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</label>
                                                            <textarea class="form-control" id="message" name="message" rows="4" 
                                                                      placeholder="–û–ø–∏—à–∏—Ç–µ, –∫–∞–∫ –≤—ã –±—É–¥–µ—Ç–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É..." required></textarea>
                                                        </div>
                                                        <button type="submit" class="btn btn-primary">
                                                            <i class="bi bi-send me-1"></i>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∫–ª–∏–∫
                                                        </button>
                                                    </form>
                                                </div>
                                            {{/unless}}
                                        {{/unless}}
                                    {{/if}}
                                {{else}}
                                    <div class="alert alert-info mb-4">
                                        <i class="bi bi-info-circle me-2"></i>
                                        <strong>–•–æ—Ç–∏—Ç–µ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –∑–∞–¥–∞—á—É?</strong>
                                        <a href="/login" class="alert-link">–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç</a> –∏–ª–∏
                                        <a href="/register" class="alert-link">–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</a>, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∫–ª–∏–∫.
                                    </div>
                                {{/if}}

                                <!-- –°–ø–∏—Å–æ–∫ –æ—Ç–∫–ª–∏–∫–æ–≤ -->
                                {{#if responses.length}}
                                    {{#each responses}}
                                        {{#if (or ../isAuthor isOwnResponse)}}
                                        <div class="mb-3 p-3 rounded {{#if (eq status 'accepted')}}border border-success border-2 bg-light{{else if (eq status 'rejected')}}border border-secondary border-2 opacity-75{{else}}border{{/if}}">
                                                <div class="d-flex justify-content-between align-items-start mb-3">
                                                    <div class="d-flex align-items-center">
                                                        <div class="rounded-circle d-flex align-items-center justify-content-center me-3" 
                                                             style="width: 48px; height: 48px; background-color: var(--youdo-light-blue);">
                                                            <i class="bi bi-person-fill" style="font-size: 24px; color: var(--youdo-blue);"></i>
                                                        </div>
                                                        <div>
                                                            <strong class="d-block">
                                                                {{#if responder.firstName}}
                                                                    {{responder.firstName}} {{responder.lastName}}
                                                                {{else}}
                                                                    {{responder.username}}
                                                                {{/if}}
                                                                {{#if (eq responder._id ../currentUserId)}}
                                                                    <span class="badge bg-info ms-2">–í—ã</span>
                                                                {{/if}}
                                                            </strong>
                                                            <small class="text-muted">{{createdAtFormatted}}</small>
                                                        </div>
                                                    </div>
                                                    <div>
                                                        {{#if (eq status 'accepted')}}
                                                            <span class="badge bg-success">
                                                                <i class="bi bi-check-circle me-1"></i>–ü—Ä–∏–Ω—è—Ç
                                                            </span>
                                                        {{else if (eq status 'rejected')}}
                                                            <span class="badge bg-secondary">–û—Ç–∫–ª–æ–Ω–µ–Ω</span>
                                                        {{else}}
                                                            <span class="badge bg-warning">–û–∂–∏–¥–∞–µ—Ç</span>
                                                        {{/if}}
                                                    </div>
                                                </div>

                                                <div id="response-display-{{_id}}">
                                                    <div class="p-3 bg-light rounded mb-3" style="border-left: 3px solid var(--youdo-blue);">
                                                        <p class="mb-0" style="white-space: pre-wrap;">{{message}}</p>
                                                    </div>
                                                </div>

                                                <div id="response-edit-{{_id}}" style="display: none;">
                                                    <form action="/tasks/{{../task._id}}/response/{{_id}}/edit" method="POST" class="mt-2">
                                                        <div class="mb-3">
                                                            <textarea class="form-control" name="message" rows="4" required>{{message}}</textarea>
                                                        </div>
                                                        <div class="d-flex gap-2">
                                                            <button type="submit" class="btn btn-success btn-sm">
                                                                <i class="bi bi-check me-1"></i>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                                                            </button>
                                                            <button type="button" class="btn btn-secondary btn-sm" onclick="cancelEdit('{{_id}}')">
                                                                <i class="bi bi-x me-1"></i>–û—Ç–º–µ–Ω–∞
                                                            </button>
                                                        </div>
                                                    </form>
                                                </div>

                                                {{#if ../isAuthor}}
                                                    {{#if (eq status 'pending')}}
                                                        <div class="d-flex gap-2 mt-3">
                                                            <form action="/tasks/{{../task._id}}/response/{{_id}}/accept" method="POST" class="d-inline">
                                                                <button type="submit" class="btn btn-success btn-sm">
                                                                    <i class="bi bi-check-circle me-1"></i>–ü—Ä–∏–Ω—è—Ç—å –æ—Ç–∫–ª–∏–∫
                                                                </button>
                                                            </form>
                                                        </div>
                                                    {{/if}}
                                                {{else if isOwnResponse}}
                                                    {{#if (eq status 'pending')}}
                                                        <div class="d-flex gap-2 mt-3" id="response-actions-{{_id}}">
                                                            <button type="button" class="btn btn-primary btn-sm" onclick="editResponse('{{_id}}')">
                                                                <i class="bi bi-pencil me-1"></i>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                                            </button>
                                                            <button type="button" class="btn btn-danger btn-sm" onclick="deleteResponse('{{_id}}')">
                                                                <i class="bi bi-trash me-1"></i>–£–¥–∞–ª–∏—Ç—å
                                                            </button>
                                                        </div>
                                                    {{/if}}
                                                {{/if}}
                                        </div>
                                        {{/if}}
                                    {{/each}}
                                {{else}}
                                    <div class="text-center py-5">
                                        <i class="bi bi-chat-dots" style="font-size: 3rem; color: #ddd;"></i>
                                        <p class="text-muted mt-3 mb-0">
                                            <i class="bi bi-info-circle me-2"></i>–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∫–ª–∏–∫–æ–≤
                                        </p>
                                    </div>
                                {{/if}}
                            </div>
                        </div>
                    </div>

                    <!-- –ü–µ—Ä–µ–ø–∏—Å–∫–∞ –º–µ–∂–¥—É —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ –∑–∞–¥–∞—á–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –±–µ–ª–æ–º –±–ª–æ–∫–µ -->
                    {{#if (and user (or (eq task.status 'in_progress') (eq task.status 'closed')))}}
                        {{#if (or isAuthor hasResponded)}}
                            <div class="mt-4">
                                <div class="card task-card">
                                    <div class="card-body p-4">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h5 class="mb-0">
                                                <i class="bi bi-chat-left-text me-2"></i>–ü–µ—Ä–µ–ø–∏—Å–∫–∞
                                                {{#if (eq task.status 'closed')}}
                                                    <span class="badge bg-secondary ms-2">–ó–∞–¥–∞—á–∞ –∑–∞–∫—Ä—ã—Ç–∞</span>
                                                {{/if}}
                                            </h5>
                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="loadMessages()">
                                                <i class="bi bi-arrow-clockwise me-1"></i>–û–±–Ω–æ–≤–∏—Ç—å
                                            </button>
                                        </div>
                                        {{#if (eq task.status 'closed')}}
                                            <div class="alert alert-warning mb-3">
                                                <i class="bi bi-info-circle me-2"></i>
                                                <strong>–ó–∞–¥–∞—á–∞ –∑–∞–∫—Ä—ã—Ç–∞</strong> - –ø–µ—Ä–µ–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ä–∞–±–æ—Ç—ã
                                            </div>
                                        {{/if}}
                                        <div id="messages-container" style="height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 15px; margin-bottom: 15px; background-color: #f8f9fa;">
                                            <div class="text-center text-muted">
                                                <div class="spinner-border spinner-border-sm" role="status">
                                                    <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</span>
                                                </div>
                                                <div class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>
                                            </div>
                                        </div>

                                        <form id="message-form">
                                            <div class="input-group">
                                                <textarea class="form-control" id="message-input" name="message" rows="3" 
                                                          placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." maxlength="1000" required></textarea>
                                                <button class="btn btn-primary" type="submit" id="send-button">
                                                    <i class="bi bi-send me-1"></i>–û—Ç–ø—Ä–∞–≤–∏—Ç—å
                                                </button>
                                            </div>
                                            <small class="form-text text-muted">–ú–∞–∫—Å–∏–º—É–º 1000 —Å–∏–º–≤–æ–ª–æ–≤. –î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Ctrl+Enter</small>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        {{/if}}
                    {{/if}}
        </div>

        <!-- –°–∞–π–¥–±–∞—Ä –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –±–µ–ª–æ–º –±–ª–æ–∫–µ -->
        <div class="col-lg-4">
            <div class="card task-card sticky-top" style="top: 20px;">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–¥–∞—á–µ
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3 pb-3 border-bottom">
                        <small class="text-muted d-block mb-1">–°—Ç–∞—Ç—É—Å</small>
                        <span class="badge {{#if (eq task.status 'open')}}bg-success{{else if (eq task.status 'in_progress')}}bg-warning{{else}}bg-secondary{{/if}}" style="font-size: 0.9rem;">
                            {{#if (eq task.status 'open')}}–û—Ç–∫—Ä—ã—Ç–∞{{else if (eq task.status 'in_progress')}}–í —Ä–∞–±–æ—Ç–µ{{else}}–ó–∞–∫—Ä—ã—Ç–∞{{/if}}
                        </span>
                    </div>

                    <div class="mb-3 pb-3 border-bottom">
                        <small class="text-muted d-block mb-1">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</small>
                        <div class="d-flex align-items-center">
                            <i class="{{task.category.icon}} me-2" style="color: var(--youdo-blue);"></i>
                            <span class="fw-bold">{{task.category.name}}</span>
                        </div>
                    </div>

                    {{#if task.acceptedResponse}}
                        <div class="mb-3 pb-3 border-bottom">
                            <small class="text-muted d-block mb-1">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</small>
                            <a href="/users/{{task.acceptedResponse.responder.username}}" target="_blank" class="text-decoration-none fw-bold d-flex align-items-center">
                                <i class="bi bi-person-check me-2" style="color: var(--youdo-blue);"></i>
                                {{#if task.acceptedResponse.responder.firstName}}
                                    {{task.acceptedResponse.responder.firstName}} {{task.acceptedResponse.responder.lastName}}
                                {{else}}
                                    {{task.acceptedResponse.responder.username}}
                                {{/if}}
                            </a>
                        </div>
                    {{/if}}

                    <div class="mb-3">
                        <small class="text-muted d-block mb-1">–°–æ–∑–¥–∞–Ω–æ</small>
                        <div class="d-flex align-items-center">
                            <i class="bi bi-calendar3 me-2" style="color: var(--youdo-blue);"></i>
                            <span>{{task.createdAtFormatted}}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ -->
            <div class="mt-3">
                <a href="/tasks" class="btn btn-outline-secondary w-100">
                    <i class="bi bi-arrow-left me-1"></i>–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É
                </a>
            </div>
        </div>
    </div>
</div>

<script>
function rejectResponse(responseId) {
  if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–ª–æ–Ω–∏—Ç—å —ç—Ç–æ—Ç –æ—Ç–∫–ª–∏–∫?')) {
    alert('–§—É–Ω–∫—Ü–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞');
  }
}

function editResponse(responseId) {
  document.getElementById('response-display-' + responseId).style.display = 'none';
  document.getElementById('response-actions-' + responseId).style.display = 'none';
  document.getElementById('response-edit-' + responseId).style.display = 'block';
}

function cancelEdit(responseId) {
  document.getElementById('response-display-' + responseId).style.display = 'block';
  const actionsEl = document.getElementById('response-actions-' + responseId);
  if (actionsEl) actionsEl.style.display = 'block';
  document.getElementById('response-edit-' + responseId).style.display = 'none';
}

function deleteResponse(responseId) {
  if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–≤–æ–π –æ—Ç–∫–ª–∏–∫?')) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/tasks/' + '{{task._id}}' + '/response/' + responseId + '/delete';

    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = '_csrf';
    csrfInput.value = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
    form.appendChild(csrfInput);

    document.body.appendChild(form);
    form.submit();
  }
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
const taskId = '{{task._id}}';
const currentUserId = '{{currentUserId}}';

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
async function loadMessages() {
  try {
    const response = await fetch(`/tasks/${taskId}/messages`);
    const data = await response.json();

    if (data.success) {
      displayMessages(data.messages);
    } else {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', data.error);
      document.getElementById('messages-container').innerHTML =
        '<div class="alert alert-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π: ' + data.error + '</div>';
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error);
    document.getElementById('messages-container').innerHTML =
      '<div class="alert alert-danger">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
  }
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
function displayMessages(messages) {
  const container = document.getElementById('messages-container');

  if (messages.length === 0) {
    container.innerHTML = '<div class="text-center text-muted py-5"><i class="bi bi-chat-left me-2"></i>–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
    return;
  }

  let html = '';
  messages.forEach(message => {
    const isSystemMessage = message.isSystemMessage || false;
    if (isSystemMessage) {
      html += `
        <div class="alert alert-info text-center mb-3" style="max-width: 85%; margin: 10px auto;">
          <small class="d-block text-muted mb-1">${new Date(message.createdAt).toLocaleString('ru-RU')}</small>
          <div><strong>üîî –°–∏—Å—Ç–µ–º–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:</strong><br>${message.message.replace(/\n/g, '<br>')}</div>
        </div>
      `;
    } else {
      const isOwn = message.sender && message.sender._id === currentUserId;
      const messageClass = isOwn ? 'alert alert-primary ms-auto' : 'alert alert-light me-auto';
      const messageStyle = isOwn ? 'margin-left: auto; margin-right: 0; max-width: 75%;' : 'margin-left: 0; margin-right: auto; max-width: 75%;';

      html += `
        <div class="${messageClass} mb-3" style="${messageStyle}">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <strong>${isOwn ? '–í—ã' : (message.sender.firstName || message.sender.username)}</strong>
            <small class="text-muted">${new Date(message.createdAt).toLocaleString('ru-RU', {hour: '2-digit', minute: '2-digit'})}</small>
          </div>
          <div style="white-space: pre-wrap;">${message.message.replace(/\n/g, '<br>')}</div>
        </div>
      `;
    }
  });

  container.innerHTML = html;
  container.scrollTop = container.scrollHeight;
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
async function sendMessage(message) {
  try {
    const response = await fetch(`/tasks/${taskId}/messages`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ message })
    });

    const data = await response.json();

    if (data.success) {
      document.getElementById('message-input').value = '';
      loadMessages();
    } else {
      alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + data.error);
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error);
    alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è');
  }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
  const messageForm = document.getElementById('message-form');
  const messageInput = document.getElementById('message-input');

  if (messageForm) {
    loadMessages();

    messageForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const message = messageInput.value.trim();

      if (message) {
        sendMessage(message);
      }
    });

    messageInput.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        const message = this.value.trim();
        if (message) {
          sendMessage(message);
        }
      }
    });
  }
});
</script>