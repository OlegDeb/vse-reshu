<div class="mb-4">
  <a href="/admin/users" class="btn btn-outline-secondary mb-3">
    <i class="fas fa-arrow-left me-2"></i>Назад к списку пользователей
  </a>
</div>

{{#if success}}
<div class="alert alert-success alert-dismissible fade show" role="alert">
  <i class="fas fa-check-circle me-2"></i>
  {{success}}
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{{/if}}

{{#if error}}
<div class="alert alert-danger alert-dismissible fade show" role="alert">
  <i class="fas fa-exclamation-triangle me-2"></i>
  {{error}}
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{{/if}}

<!-- Информация о пользователе -->
<div class="card mb-4">
  <div class="card-header bg-primary text-white">
    <h3 class="mb-0">
      <i class="bi bi-person-circle me-2"></i>Информация о пользователе
    </h3>
  </div>
  <div class="card-body">
    <div class="row mb-3">
      <div class="col-md-3 text-center">
        {{#if user.avatar}}
          <img src="{{user.avatar}}" alt="{{user.username}}" class="rounded-circle mb-3" style="width: 150px; height: 150px; object-fit: cover;">
        {{else}}
          <i class="bi bi-person-circle" style="font-size: 150px; color: #6c757d;"></i>
        {{/if}}
      </div>
      <div class="col-md-9">
        <h4>
          {{#if user.firstName}}{{user.firstName}} {{user.lastName}}{{else}}{{user.username}}{{/if}}
          {{#if (eq user.role "admin")}}
          <span class="badge bg-danger ms-2">Администратор</span>
          {{/if}}
        </h4>
        <p class="text-muted mb-2">@{{user.username}}</p>
        <p><strong>Email:</strong> {{user.email}}</p>
        {{#if user.phone}}
        <p><strong>Телефон:</strong> {{user.phone}}</p>
        {{/if}}
        {{#if user.dateOfBirth}}
        <p><strong>Дата рождения:</strong> {{formatDate user.dateOfBirth}}</p>
        {{/if}}
        {{#if user.gender}}
        <p><strong>Пол:</strong> {{user.gender}}</p>
        {{/if}}
        <p><strong>Дата регистрации:</strong> {{user.createdAtFormatted}}</p>
        {{#if user.lastLogin}}
        <p><strong>Последний вход:</strong> {{formatDate user.lastLogin}}</p>
        {{/if}}
        {{#if user.bio}}
        <p><strong>О себе:</strong> {{user.bio}}</p>
        {{/if}}
      </div>
    </div>
    
    <!-- Статус бана -->
    <div class="row mt-3">
      <div class="col-12">
        <div class="alert {{#if (eq user.banStatus 'none')}}alert-success{{else if (eq user.banStatus 'temporary')}}alert-warning{{else}}alert-danger{{/if}}" role="alert">
          <h5 class="alert-heading">
            {{#if (eq user.banStatus 'none')}}
            <i class="fas fa-check-circle me-2"></i>Пользователь активен
            {{else if (eq user.banStatus 'temporary')}}
            <i class="fas fa-clock me-2"></i>Временный бан
            {{else}}
            <i class="fas fa-ban me-2"></i>Постоянный бан
            {{/if}}
          </h5>
          {{#if (neq user.banStatus 'none')}}
          <p class="mb-1"><strong>Причина бана:</strong> {{user.banReason}}</p>
          {{#if user.banUntil}}
          <p class="mb-1"><strong>Бан до:</strong> {{user.banUntilFormattedFull}}</p>
          {{/if}}
          {{#if user.bannedBy}}
          <p class="mb-1"><strong>Забанен:</strong> {{#if user.bannedBy.firstName}}{{user.bannedBy.firstName}} {{user.bannedBy.lastName}}{{else}}{{user.bannedBy.username}}{{/if}}</p>
          {{/if}}
          {{#if user.bannedAt}}
          <p class="mb-0"><strong>Дата бана:</strong> {{user.bannedAtFormattedFull}}</p>
          {{/if}}
          {{/if}}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Предупреждения -->
<div class="card mb-4">
  <div class="card-header bg-warning text-dark">
    <h4 class="mb-0">
      <i class="bi bi-exclamation-triangle me-2"></i>Предупреждения ({{user.warnings.length}})
    </h4>
  </div>
  <div class="card-body">
    {{#if user.warnings.length}}
    <div class="list-group">
      {{#each user.warnings}}
      <div class="list-group-item">
        <div class="d-flex justify-content-between align-items-start">
          <div class="flex-grow-1">
            <h6 class="mb-1">{{this.reason}}</h6>
            <small class="text-muted">
              Выдано: {{this.issuedAtFormatted}}
              {{#if this.issuedBy}}
              | Модератор: {{#if this.issuedBy.firstName}}{{this.issuedBy.firstName}} {{this.issuedBy.lastName}}{{else}}{{this.issuedBy.username}}{{/if}}
              {{/if}}
            </small>
          </div>
          <form action="/admin/users/{{../user._id}}/warning/{{this._id}}/remove" method="POST" class="ms-2" onsubmit="return confirm('Удалить это предупреждение?')">
            <button type="submit" class="btn btn-outline-danger btn-sm">
              <i class="fas fa-times"></i>
            </button>
          </form>
        </div>
      </div>
      {{/each}}
    </div>
    {{else}}
    <p class="text-muted mb-0">У пользователя нет предупреждений</p>
    {{/if}}
    
    <!-- Форма добавления предупреждения -->
    <div class="mt-4 pt-4 border-top">
      <h5>Выдать предупреждение</h5>
      <form action="/admin/users/{{user._id}}/warning" method="POST">
        <div class="mb-3">
          <label for="warningReason" class="form-label">Причина предупреждения <span class="text-danger">*</span></label>
          <textarea class="form-control" id="warningReason" name="reason" rows="3" required placeholder="Укажите причину предупреждения..."></textarea>
        </div>
        <button type="submit" class="btn btn-warning">
          <i class="fas fa-exclamation-triangle me-2"></i>Выдать предупреждение
        </button>
      </form>
    </div>
  </div>
</div>

<!-- Действия модерации -->
<div class="card mb-4">
  <div class="card-header bg-danger text-white">
    <h4 class="mb-0">
      <i class="bi bi-shield-exclamation me-2"></i>Действия модерации
    </h4>
  </div>
  <div class="card-body">
    {{#if (eq user.banStatus 'none')}}
    <!-- Временный бан -->
    <div class="mb-4 pb-4 border-bottom">
      <h5 class="text-warning">
        <i class="fas fa-clock me-2"></i>Временный бан
      </h5>
      <form action="/admin/users/{{user._id}}/ban/temporary" method="POST" onsubmit="return confirm('Забанить пользователя временно?')">
        <div class="row">
          <div class="col-md-4 mb-3">
            <label for="banDays" class="form-label">Количество дней <span class="text-danger">*</span></label>
            <input type="number" class="form-control" id="banDays" name="banDays" min="1" max="365" value="7" required>
            <small class="form-text text-muted">От 1 до 365 дней</small>
          </div>
          <div class="col-md-8 mb-3">
            <label for="tempBanReason" class="form-label">Причина бана <span class="text-danger">*</span></label>
            <textarea class="form-control" id="tempBanReason" name="reason" rows="2" required placeholder="Укажите причину временного бана..."></textarea>
          </div>
        </div>
        <button type="submit" class="btn btn-warning" {{#if (eq user.role 'admin')}}disabled title="Нельзя забанить администратора"{{/if}}>
          <i class="fas fa-ban me-2"></i>Забанить временно
        </button>
      </form>
    </div>
    
    <!-- Постоянный бан -->
    <div>
      <h5 class="text-danger">
        <i class="fas fa-ban me-2"></i>Постоянный бан
      </h5>
      <form action="/admin/users/{{user._id}}/ban/permanent" method="POST" onsubmit="return confirm('Забанить пользователя навсегда? Это действие нельзя отменить!')">
        <div class="mb-3">
          <label for="permBanReason" class="form-label">Причина бана <span class="text-danger">*</span></label>
          <textarea class="form-control" id="permBanReason" name="reason" rows="3" required placeholder="Укажите причину постоянного бана..."></textarea>
        </div>
        <button type="submit" class="btn btn-danger" {{#if (eq user.role 'admin')}}disabled title="Нельзя забанить администратора"{{/if}}>
          <i class="fas fa-ban me-2"></i>Забанить навсегда
        </button>
      </form>
    </div>
    {{else}}
    <!-- Разбан -->
    <div>
      <h5 class="text-success">
        <i class="fas fa-unlock me-2"></i>Разбан пользователя
      </h5>
      <p class="text-muted">Пользователь в настоящее время забанен. Вы можете снять бан.</p>
      <form action="/admin/users/{{user._id}}/unban" method="POST" onsubmit="return confirm('Разбанить пользователя?')">
        <button type="submit" class="btn btn-success">
          <i class="fas fa-unlock me-2"></i>Разбанить
        </button>
      </form>
    </div>
    {{/if}}
  </div>
</div>

